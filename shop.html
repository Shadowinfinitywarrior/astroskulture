<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop - Astros Kulture</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="navbar">
        <div class="logo">
            <img src="logo.png" alt="Astros Kulture">
        </div>
        <div class="mobile-controls">
            <div class="mobile-search">
                <input type="text" placeholder="Search" id="mobile-search">
            </div>
            <a href="cart.html" class="mobile-cart">Cart</a>
            <div class="menu-toggle">☰</div>
        </div>
        <ul class="nav-links">
            <li><a href="index.html">Home</a></li>
            <li class="dropdown-parent">
                <a href="#">Products</a>
                <ul class="dropdown">
                    <li><a href="shop.html?category=oversized">Oversized T-shirts</a></li>
                    <li><a href="shop.html?category=normal">Normal T-shirts</a></li>
                    <li><a href="shop.html?category=shirts">Shirts</a></li>
                    <li><a href="shop.html?category=pants">Men Cotton Pants</a></li>
                </ul>
            </li>
            <li class="dropdown-parent">
                <a href="#">Account</a>
                <ul class="dropdown" id="account-menu">
                    <li><a href="login.html" class="login-link">Login</a></li>
                    <li><a href="register.html" class="login-link">Register</a></li>
                    <li><a href="account.html" class="dashboard-link">Dashboard</a></li>
                </ul>
            </li>
            <li class="desktop-search">
                <input type="text" placeholder="Search" id="search" onkeyup="searchProducts()">
            </li>
            <li class="desktop-cart">
                <a href="cart.html">Cart</a>
            </li>
        </ul>
    </nav>

    <!-- Quick Categories -->
    <section class="quick-categories">
        <div class="category-nav">
            <a href="shop.html" class="category-link">All</a>
            <a href="shop.html?category=shirts" class="category-link">Shirts</a>
            <a href="shop.html?category=pants" class="category-link">Men Cotton Pants</a>
            <a href="shop.html?category=oversized" class="category-link">Oversized T-Shirts</a>
        </div>
    </section>

    <section class="shop-grid fade-in">
        <h2 id="category-title"></h2>
        <div class="filters">
            <select id="sort">
                <option value="price-asc">Price: Low to High</option>
                <option value="price-desc">Price: High to Low</option>
                <option value="name-asc">Name: A to Z</option>
                <option value="discount">Best Discount</option>
            </select>
        </div>
        <div id="products" class="products-grid"></div>
    </section>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3>Contact Information</h3>
                <p><strong>MAIL SUPPORT:</strong> help.astroskulture@gmail.com</p>
                <p><strong>WHATSAPP:</strong> 7871658830</p>
                <p><strong>INSTAGRAM:</strong> <a href="https://www.instagram.com/astroskulture.in" target="_blank">@astroskulture.in</a></p>
                <p><strong>ADDRESS:</strong> 21c/144B North Kennedy St, MKP Nagar, Palaiyamkottai - Tirunelveli 627002</p>
            </div>
            <div class="footer-section">
                <h3>Quick Links</h3>
                <a href="index.html">Home</a>
                <a href="shop.html">Shop</a>
                <a href="cart.html">Cart</a>
                <a href="account.html">Account</a>
            </div>
            <div class="footer-section">
                <h3>Policies</h3>
                <a href="#">Terms & Conditions</a>
                <a href="#">Privacy Policy</a>
                <a href="#">Return Policy</a>
                <a href="#">Shipping Policy</a>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 Astros Kulture. All rights reserved.</p>
        </div>
    </footer>

    <script src="script.js"></script>
    <script>
        updateAccountMenu();
        async function loadProducts() {
            const urlParams = new URLSearchParams(window.location.search);
            const category = urlParams.get('category') || '';
            try {
                let url = `/api/products${category ? `?category=${category}` : ''}`;
                const sort = document.getElementById('sort').value;
                if (sort) url += `${category ? '&' : '?'}sort=${sort}`;
                const response = await fetch(url);
                const data = await response.json();
                if (data.success) {
                    document.getElementById('category-title').textContent = category ? category.charAt(0).toUpperCase() + category.slice(1) + ' T-shirts' : 'All Products';
                    displayProducts(data.products);
                } else {
                    document.getElementById('products').innerHTML = '<p>No products found</p>';
                }
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('products').innerHTML = '<p>Error loading products. Please try again.</p>';
            }
        }

        function displayProducts(products) {
            const sort = document.getElementById('sort').value;
            let sortedProducts = [...products];
            if (sort === 'price-asc') sortedProducts.sort((a, b) => a.price - b.price);
            else if (sort === 'price-desc') sortedProducts.sort((a, b) => b.price - a.price);
            else if (sort === 'name-asc') sortedProducts.sort((a, b) => a.name.localeCompare(b.name));
            else if (sort === 'discount') {
                sortedProducts.sort((a, b) => {
                    const discountA = a.originalPrice ? ((a.originalPrice - a.price) / a.originalPrice) * 100 : 0;
                    const discountB = b.originalPrice ? ((b.originalPrice - b.price) / b.originalPrice) * 100 : 0;
                    return discountB - discountA;
                });
            }
            
            const searchTerm = document.getElementById('search').value.toLowerCase();
            const filteredProducts = searchTerm ? sortedProducts.filter(p => p.name.toLowerCase().includes(searchTerm)) : sortedProducts;
            
            document.getElementById('products').innerHTML = filteredProducts.map(product => {
                const discount = product.originalPrice && product.originalPrice > product.price ? 
                    Math.round(((product.originalPrice - product.price) / product.originalPrice) * 100) : 0;
                
                return `
                    <div class="product-card">
                        <div class="product-image">
                            <img src="${product.images[0] || 'logo.png'}" alt="${product.name}" onerror="this.src='logo.png';">
                            ${discount > 0 ? `<div class="discount-badge">${discount}% OFF</div>` : ''}
                        </div>
                        <div class="product-info">
                            <h3>${product.name}</h3>
                            <div class="rating">${product.rating || '4.0'} ★ | ${product.reviewCount || '0'}</div>
                            <div class="price">
                                <span class="current-price">₹${(product.price || 0).toFixed(2)}</span>
                                ${product.originalPrice && product.originalPrice > product.price ? 
                                    `<span class="original-price">₹${product.originalPrice.toFixed(2)}</span>` : ''
                                }
                                ${discount > 0 ? `<span class="discount">${discount}% off</span>` : ''}
                            </div>
                            <div class="product-actions">
                                <a href="product.html?id=${product._id}" class="btn view-btn" onclick="addToRecentlyViewed('${product._id}')">View</a>
                                <button class="btn cart-btn" onclick="addToCart('${product._id}')">Add to Cart</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        document.getElementById('sort').addEventListener('change', loadProducts);
        document.getElementById('search').addEventListener('keyup', loadProducts);

        // Mobile search functionality
        document.getElementById('mobile-search').addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                searchProducts();
            }
        });

        async function searchProducts() {
            const searchTerm = document.getElementById('search').value.toLowerCase();
            if (searchTerm.length < 3) {
                loadProducts();
                return;
            }
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const category = urlParams.get('category') || '';
                const response = await fetch(`/api/products/search?query=${searchTerm}${category ? `&category=${category}` : ''}`);
                const data = await response.json();
                if (data.success) {
                    document.getElementById('category-title').textContent = `Search Results for "${searchTerm}"`;
                    displayProducts(data.products);
                } else {
                    document.getElementById('products').innerHTML = '<p>No products found</p>';
                }
            } catch (error) {
                console.error('Error searching products:', error);
                document.getElementById('products').innerHTML = '<p>Error searching products. Please try again.</p>';
            }
        }

        function addToRecentlyViewed(productId) {
            let recentlyViewed = JSON.parse(localStorage.getItem('recentlyViewed') || '[]');
            if (!recentlyViewed.includes(productId)) {
                recentlyViewed.unshift(productId);
                recentlyViewed = recentlyViewed.slice(0, 10);
                localStorage.setItem('recentlyViewed', JSON.stringify(recentlyViewed));
            }
        }

        loadProducts();
    </script>
</body>
</html>
