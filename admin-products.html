<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Products - Astros Kulture</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="navbar">
        <div class="logo">
            <img src="logo.png" alt="Astros Kulture">
        </div>
        <div class="menu-toggle">â˜°</div>
        <ul class="nav-links">
            <li><a href="admin.html">Dashboard</a></li>
            <li><a href="admin-home.html">Home Config</a></li>
            <li><a href="admin-products.html">Products</a></li>
            <li><a href="admin-orders.html">Orders</a></li>
            <li><a href="admin-users.html">Users</a></li>
            <li><a href="#" onclick="logout()">Logout</a></li>
        </ul>
    </nav>

    <section class="admin fade-in">
        <h2>Manage Products</h2>
        <form id="product-form" class="home-config-form slide-in-left">
            <input type="hidden" id="product-id">
            <input type="text" id="product-name" placeholder="Product Name" required>
            <input type="text" id="product-category" placeholder="Category (oversized/normal)" required>
            <input type="number" id="product-price" placeholder="Price" step="0.01" min="0" required>
            <input type="text" id="product-image1" placeholder="Image URL 1">
            <input type="text" id="product-image2" placeholder="Image URL 2">
            <input type="text" id="product-image3" placeholder="Image URL 3">
            <textarea id="product-description" placeholder="Description"></textarea>
            <button type="submit" id="product-submit">Add Product</button>
        </form>
        <div id="products" class="products-grid"></div>
    </section>

    <footer>
        <p>&copy; 2025 Astros Kulture. Contact: info@astroskulture.com</p>
        <div class="footer-links">
            <a href="#">Terms</a>
            <a href="#">Privacy</a>
            <a href="#">Return Policy</a>
        </div>
    </footer>

    <script src="script.js"></script>
    <script>
        async function checkAdmin() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }
            try {
                const response = await fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                // FIX: Changed from data.user.role to data.data.role
                if (!data.success || data.data.role !== 'admin') {
                    window.location.href = 'login.html';
                    return false;
                }
                return true;
            } catch (error) {
                window.location.href = 'login.html';
                return false;
            }
        }

        async function loadProducts() {
            try {
                const response = await fetch('/api/admin/products', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const data = await response.json();
                if (data.success) {
                    document.getElementById('products').innerHTML = data.products.map(product => `
                        <div class="product-item">
                            <p><strong>Name:</strong> ${product.name}</p>
                            <p><strong>Category:</strong> ${product.category}</p>
                            <p><strong>Price:</strong> $${(product.price || 0).toFixed(2)}</p>
                            <p><strong>Images:</strong> ${product.images ? product.images.join(', ') : 'No images'}</p>
                            <p><strong>Description:</strong> ${product.description || 'No description'}</p>
                            <p><strong>Created:</strong> ${new Date(product.createdAt || Date.now()).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' })}</p>
                            <button class="btn" onclick="editProduct('${product._id}', '${product.name}', '${product.category}', ${product.price}, ${JSON.stringify(product.images || [])}, '${(product.description || '').replace(/'/g, "\\'")}')">Edit</button>
                            <button class="btn" onclick="deleteProduct('${product._id}')">Delete</button>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('products').innerHTML = '<p>No products found or access denied.</p>';
                }
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('products').innerHTML = '<p>Error loading products. Please try again.</p>';
            }
        }

        document.getElementById('product-form').addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('product-id').value;
            const images = [
                document.getElementById('product-image1').value,
                document.getElementById('product-image2').value,
                document.getElementById('product-image3').value
            ].filter(img => img.trim() !== '');
            
            const product = {
                name: document.getElementById('product-name').value.trim(),
                category: document.getElementById('product-category').value.trim(),
                price: parseFloat(document.getElementById('product-price').value),
                images: images,
                description: document.getElementById('product-description').value.trim()
            };
            
            if (product.price < 0) {
                alert('Price cannot be negative');
                return;
            }
            
            try {
                const method = id ? 'PUT' : 'POST';
                const url = id ? `/api/admin/products/${id}` : '/api/admin/products';
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(product)
                });
                const data = await response.json();
                if (data.success) {
                    alert(id ? 'Product updated successfully' : 'Product added successfully');
                    resetProductForm();
                    loadProducts();
                } else {
                    alert(data.message || 'Failed to save product');
                }
            } catch (error) {
                console.error('Error saving product:', error);
                alert('Error saving product');
            }
        });

        function editProduct(id, name, category, price, images, description) {
            document.getElementById('product-id').value = id;
            document.getElementById('product-name').value = name;
            document.getElementById('product-category').value = category;
            document.getElementById('product-price').value = price;
            
            // Handle images array properly
            const imageArray = Array.isArray(images) ? images : [];
            document.getElementById('product-image1').value = imageArray[0] || '';
            document.getElementById('product-image2').value = imageArray[1] || '';
            document.getElementById('product-image3').value = imageArray[2] || '';
            
            document.getElementById('product-description').value = description;
            document.getElementById('product-submit').textContent = 'Update Product';
        }

        function resetProductForm() {
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            document.getElementById('product-submit').textContent = 'Add Product';
        }

        async function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                try {
                    const response = await fetch(`/api/admin/products/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    const data = await response.json();
                    if (data.success) {
                        alert('Product deleted successfully');
                        loadProducts();
                    } else {
                        alert(data.message || 'Failed to delete product');
                    }
                } catch (error) {
                    console.error('Error deleting product:', error);
                    alert('Error deleting product');
                }
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            const isAdmin = await checkAdmin();
            if (isAdmin) {
                loadProducts();
            }
        });
    </script>
</body>
</html>
