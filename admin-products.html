<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Products - Astros Kulture</title>
    <link rel="stylesheet" href="./admin-style.css">
</head>
<body>
    <nav class="navbar">
        <div class="logo">
            <img src="logo.png" alt="Astros Kulture">
        </div>
        <div class="mobile-controls">
            <div class="mobile-search">
                <input type="text" placeholder="Search products..." id="mobile-product-search">
            </div>
            <div class="menu-toggle">‚ò∞</div>
        </div>
        <ul class="nav-links">
            <li><a href="admin.html">Dashboard</a></li>
            <li><a href="admin-home.html">Home Config</a></li>
            <li><a href="admin-products.html" class="active">Products</a></li>
            <li><a href="admin-orders.html">Orders</a></li>
            <li><a href="admin-users.html">Users</a></li>
            <li><a href="#" onclick="logout()">Logout</a></li>
            <li class="desktop-search">
                <input type="text" placeholder="Search products..." id="product-search">
            </li>
        </ul>
    </nav>

    <section class="admin fade-in">
        <div class="admin-header">
            <h2>Manage Products</h2>
            <div class="admin-stats">
                <div class="stat-card">
                    <h3>Total Products</h3>
                    <span id="total-products">0</span>
                </div>
                <div class="stat-card">
                    <h3>In Stock</h3>
                    <span id="in-stock-products">0</span>
                </div>
                <div class="stat-card">
                    <h3>Low Stock</h3>
                    <span id="low-stock-products">0</span>
                </div>
                <div class="stat-card">
                    <h3>Out of Stock</h3>
                    <span id="out-of-stock-products">0</span>
                </div>
            </div>
        </div>

        <!-- Search and Filter Bar -->
        <div class="admin-toolbar">
            <div class="search-filters">
                <input type="text" id="search-products" placeholder="Search by name, brand, category..." onkeyup="filterProducts()">
                <select id="category-filter" onchange="filterProducts()">
                    <option value="all">All Categories</option>
                    <option value="oversized">Oversized T-shirts</option>
                    <option value="normal">Normal T-shirts</option>
                    <option value="shirts">Shirts</option>
                    <option value="pants">Men Cotton Pants</option>
                    <option value="jackets">Jackets</option>
                    <option value="joggers">Joggers</option>
                </select>
                <select id="stock-filter" onchange="filterProducts()">
                    <option value="all">All Stock</option>
                    <option value="in-stock">In Stock (>10)</option>
                    <option value="low-stock">Low Stock (1-10)</option>
                    <option value="out-of-stock">Out of Stock</option>
                </select>
                <select id="status-filter" onchange="filterProducts()">
                    <option value="all">All Status</option>
                    <option value="featured">Featured</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>
            <button class="btn primary-btn" onclick="toggleProductForm()" id="toggle-form-btn">
                <span>+</span> Add New Product
            </button>
        </div>

        <!-- Product Form -->
        <form id="product-form" class="product-form slide-in-left" style="display: none;">
            <div class="form-header">
                <h3 id="form-title">Add New Product</h3>
                <button type="button" class="close-btn" onclick="toggleProductForm()">√ó</button>
            </div>
            
            <input type="hidden" id="product-id">
            
            <div class="form-sections">
                <!-- Basic Information -->
                <div class="form-section">
                    <h4>Basic Information</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="product-name">Product Name *</label>
                            <input type="text" id="product-name" placeholder="e.g., MUSIC OVERSIZED HEAVYWEIGHT T-SHIRT" required>
                        </div>
                        <div class="form-group">
                            <label for="product-brand">Brand *</label>
                            <input type="text" id="product-brand" placeholder="e.g., SPACEOUT, ASOS DESIGN" value="Astros Kulture" required>
                        </div>
                        <div class="form-group">
                            <label for="product-category">Category *</label>
                            <select id="product-category" required>
                                <option value="">Select Category</option>
                                <option value="oversized">Oversized T-shirts</option>
                                <option value="normal">Normal T-shirts</option>
                                <option value="shirts">Shirts</option>
                                <option value="pants">Men Cotton Pants</option>
                                <option value="jackets">Jackets</option>
                                <option value="joggers">Joggers</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="product-fit">Fit Type</label>
                            <select id="product-fit">
                                <option value="regular">Regular</option>
                                <option value="oversized">Oversized</option>
                                <option value="slim">Slim</option>
                                <option value="baggy">Baggy</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Pricing -->
                <div class="form-section">
                    <h4>Pricing & Inventory</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="product-price">Current Price (‚Çπ) *</label>
                            <input type="number" id="product-price" placeholder="999.00" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="product-original-price">Original Price (‚Çπ)</label>
                            <input type="number" id="product-original-price" placeholder="1399.00" step="0.01" min="0">
                            <small>Leave empty if no discount</small>
                        </div>
                        <div class="form-group">
                            <label for="product-stock">Stock Quantity *</label>
                            <input type="number" id="product-stock" placeholder="50" min="0" value="0" required>
                        </div>
                        <div class="form-group">
                            <label for="product-sku">SKU</label>
                            <input type="text" id="product-sku" placeholder="AK-TS-001">
                        </div>
                    </div>
                </div>

                <!-- Product Images -->
                <div class="form-section">
                    <h4>Product Images</h4>
                    <small>Enter image URLs (up to 5 images, first image will be main display)</small>
                    <div class="image-urls-grid">
                        <div class="form-group">
                            <label>Main Image URL *</label>
                            <input type="text" id="product-image1" placeholder="https://example.com/image1.jpg" required>
                        </div>
                        <div class="form-group">
                            <label>Image URL 2</label>
                            <input type="text" id="product-image2" placeholder="https://example.com/image2.jpg">
                        </div>
                        <div class="form-group">
                            <label>Image URL 3</label>
                            <input type="text" id="product-image3" placeholder="https://example.com/image3.jpg">
                        </div>
                        <div class="form-group">
                            <label>Image URL 4</label>
                            <input type="text" id="product-image4" placeholder="https://example.com/image4.jpg">
                        </div>
                        <div class="form-group">
                            <label>Image URL 5</label>
                            <input type="text" id="product-image5" placeholder="https://example.com/image5.jpg">
                        </div>
                    </div>
                </div>

                <!-- Product Description -->
                <div class="form-section">
                    <h4>Product Description</h4>
                    <div class="form-group">
                        <label for="product-description">Short Description *</label>
                        <textarea id="product-description" placeholder="Brief description for product listings..." rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="product-detailed-description">Detailed Description</label>
                        <textarea id="product-detailed-description" placeholder="Full product description with features, benefits... (supports HTML)" rows="5"></textarea>
                    </div>
                </div>

                <!-- Product Specifications -->
                <div class="form-section">
                    <h4>Product Specifications</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="product-color">Color</label>
                            <input type="text" id="product-color" placeholder="e.g., Black, White, Navy Blue">
                        </div>
                        <div class="form-group">
                            <label for="product-fabric">Fabric Material *</label>
                            <input type="text" id="product-fabric" placeholder="e.g., 100% Cotton, Heavyweight" required>
                        </div>
                        <div class="form-group">
                            <label for="product-print-type">Print Type</label>
                            <input type="text" id="product-print-type" placeholder="e.g., Puff Print, Screen Print">
                        </div>
                        <div class="form-group">
                            <label for="product-material">Material Composition</label>
                            <input type="text" id="product-material" placeholder="e.g., 250-260 GSM Looper Cotton" value="100% Cotton">
                        </div>
                    </div>
                </div>

                <!-- Sizes Available -->
                <div class="form-section">
                    <h4>Available Sizes</h4>
                    <div class="sizes-checkbox">
                        <label class="checkbox-label">
                            <input type="checkbox" name="sizes" value="S" checked> S
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="sizes" value="M" checked> M
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="sizes" value="L" checked> L
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="sizes" value="XL" checked> XL
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="sizes" value="XXL"> XXL
                        </label>
                    </div>
                </div>

                <!-- Product Details -->
                <div class="form-section">
                    <h4>Product Details</h4>
                    <div class="form-group">
                        <label for="product-details">Key Features & Details</label>
                        <textarea id="product-details" placeholder="Enter key features, one per line:
‚Ä¢ Unisex, Oversized Comfort Fit
‚Ä¢ 250-260 GSM Looper Cotton
‚Ä¢ High Density Puff Print
‚Ä¢ Machine Washable" rows="6"></textarea>
                    </div>
                </div>

                <!-- Care Instructions -->
                <div class="form-section">
                    <h4>Care Instructions</h4>
                    <div class="form-group">
                        <label for="product-care-instructions">Care & Maintenance</label>
                        <textarea id="product-care-instructions" placeholder="Enter care instructions, one per line:
‚Ä¢ Machine Reverse Wash
‚Ä¢ Steam Iron Only
‚Ä¢ Do Not Bleach
‚Ä¢ Dry in Shade" rows="4"></textarea>
                    </div>
                </div>

                <!-- Additional Information -->
                <div class="form-section">
                    <h4>Additional Information</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="product-delivery-time">Delivery Time</label>
                            <input type="text" id="product-delivery-time" placeholder="e.g., 3-5 business days" value="3-7 business days">
                        </div>
                        <div class="form-group">
                            <label for="product-rating">Initial Rating</label>
                            <select id="product-rating">
                                <option value="4.5">4.5 ‚òÖ</option>
                                <option value="4.0">4.0 ‚òÖ</option>
                                <option value="5.0">5.0 ‚òÖ</option>
                                <option value="3.5">3.5 ‚òÖ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="product-review-count">Initial Review Count</label>
                            <input type="number" id="product-review-count" placeholder="0" min="0" value="0">
                        </div>
                        <div class="form-group checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="product-featured"> Featured Product
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="product-active" checked> Active Product
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" id="product-submit" class="btn primary-btn">Add Product</button>
                <button type="button" class="btn secondary-btn" onclick="resetProductForm()">Reset Form</button>
                <button type="button" class="btn secondary-btn" onclick="toggleProductForm()">Cancel</button>
            </div>
        </form>

        <!-- Products Grid -->
        <div class="products-grid-container">
            <div class="products-header">
                <div class="products-info">
                    <span id="products-count" class="count-badge">0 products</span>
                    <span id="filter-info" class="filter-info"></span>
                </div>
                <div class="products-actions">
                    <button class="btn secondary-btn" onclick="exportProducts()">Export Products</button>
                    <button class="btn secondary-btn" onclick="bulkUpdateStock()">Bulk Stock Update</button>
                </div>
            </div>
            
            <div id="products" class="admin-products-grid"></div>
        </div>
        
        <!-- Loading State -->
        <div id="loading" class="loading-state">
            <div class="loading-spinner"></div>
            <p>Loading products...</p>
        </div>

        <!-- No Products State -->
        <div id="no-products" class="no-data-state" style="display: none;">
            <div class="no-data-content">
                <h3>No Products Found</h3>
                <p>There are no products matching your criteria.</p>
                <button class="btn primary-btn" onclick="resetFilters()">Clear Filters</button>
                <button class="btn secondary-btn" onclick="toggleProductForm()">Add New Product</button>
            </div>
        </div>
    </section>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3>Contact Information</h3>
                <p><strong>MAIL SUPPORT:</strong> help.astroskulture@gmail.com</p>
                <p><strong>WHATSAPP:</strong> 7871658830</p>
                <p><strong>INSTAGRAM:</strong> <a href="https://www.instagram.com/astroskulture.in" target="_blank">@astroskulture.in</a></p>
                <p><strong>ADDRESS:</strong> 21c/144B North Kennedy St, MKP Nagar, Palaiyamkottai - Tirunelveli 627002</p>
            </div>
            <div class="footer-section">
                <h3>Quick Links</h3>
                <a href="index.html">Store Front</a>
                <a href="admin.html">Admin Dashboard</a>
                <a href="admin-products.html">Manage Products</a>
                <a href="admin-orders.html">Manage Orders</a>
            </div>
            <div class="footer-section">
                <h3>Policies</h3>
                <a href="#">Terms & Conditions</a>
                <a href="#">Privacy Policy</a>
                <a href="#">Return Policy</a>
                <a href="#">Shipping Policy</a>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 Astros Kulture. All rights reserved.</p>
        </div>
    </footer>

    <script src="script.js"></script>
    <script>
        let allProducts = [];
        
        async function checkAdmin() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }
            try {
                const response = await fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (!data.success || data.data.role !== 'admin') {
                    window.location.href = 'login.html';
                    return false;
                }
                return true;
            } catch (error) {
                window.location.href = 'login.html';
                return false;
            }
        }

        async function loadProducts() {
            showLoading();
            try {
                const response = await fetch('/api/admin/products', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const data = await response.json();
                if (data.success) {
                    allProducts = data.products;
                    displayProducts(allProducts);
                    updateStats(allProducts);
                    hideLoading();
                } else {
                    showNoProducts();
                    hideLoading();
                }
            } catch (error) {
                console.error('Error loading products:', error);
                showError('Error loading products. Please try again.');
                hideLoading();
            }
        }

        function displayProducts(products) {
            const container = document.getElementById('products');
            
            if (products.length === 0) {
                showNoProducts();
                return;
            }

            container.innerHTML = products.map(product => {
                const discount = product.originalPrice && product.originalPrice > product.price ? 
                    Math.round(((product.originalPrice - product.price) / product.originalPrice) * 100) : 0;
                
                const stockStatus = getStockStatus(product.stock || 0);
                const statusClass = `status-${stockStatus}`;
                
                return `
                    <div class="product-card admin-product-card" data-category="${product.category}" data-stock="${stockStatus}">
                        <div class="product-image">
                            ${product.images && product.images.length > 0 ? 
                                `<img src="${product.images[0]}" alt="${product.name}" 
                                     onerror="this.src='logo.png'">` : 
                                `<div class="no-image">No Image</div>`
                            }
                            ${discount > 0 ? `<div class="discount-badge">${discount}% OFF</div>` : ''}
                            <div class="stock-badge ${statusClass}">${stockStatus.replace('-', ' ')}</div>
                            ${product.featured ? `<div class="featured-badge">Featured</div>` : ''}
                        </div>
                        <div class="product-info">
                            <h4 class="product-name">${product.name}</h4>
                            <p class="product-brand">${product.brand || 'Astros Kulture'}</p>
                            <p class="product-category">${product.category} ‚Ä¢ ${product.fit || 'Regular'} Fit</p>
                            <div class="price-section">
                                <span class="current-price">‚Çπ${(product.price || 0).toFixed(2)}</span>
                                ${product.originalPrice && product.originalPrice > product.price ? 
                                    `<span class="original-price">‚Çπ${product.originalPrice.toFixed(2)}</span>` : 
                                    ''
                                }
                            </div>
                            <div class="product-meta">
                                <div class="meta-item">
                                    <strong>Stock:</strong> ${product.stock || 0}
                                </div>
                                <div class="meta-item">
                                    <strong>Color:</strong> ${product.color || 'N/A'}
                                </div>
                                <div class="meta-item">
                                    <strong>Sizes:</strong> ${product.sizes ? product.sizes.join(', ') : 'M, L, XL'}
                                </div>
                                <div class="meta-item">
                                    <strong>Rating:</strong> ${product.rating || 4.0} ‚òÖ (${product.reviewCount || 0})
                                </div>
                            </div>
                            <p class="created-date">
                                Created: ${new Date(product.createdAt).toLocaleDateString('en-IN')}
                            </p>
                        </div>
                        <div class="product-actions">
                            <button class="btn edit-btn" onclick="editProduct('${product._id}')" title="Edit Product">
                                <span>‚úèÔ∏è Edit</span>
                            </button>
                            <button class="btn view-btn" onclick="viewProduct('${product._id}')" title="View Product">
                                <span>üëÅÔ∏è View</span>
                            </button>
                            <button class="btn delete-btn" onclick="deleteProduct('${product._id}')" title="Delete Product">
                                <span>üóëÔ∏è Delete</span>
                            </button>
                            <button class="btn stock-btn" onclick="quickUpdateStock('${product._id}', ${product.stock || 0})" title="Update Stock">
                                <span>üì¶ Stock</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // Hide no products message
            document.getElementById('no-products').style.display = 'none';
        }

        function getStockStatus(stock) {
            if (stock > 10) return 'in-stock';
            if (stock > 0) return 'low-stock';
            return 'out-of-stock';
        }

        function updateStats(products) {
            const totalProducts = products.length;
            const inStock = products.filter(p => (p.stock || 0) > 10).length;
            const lowStock = products.filter(p => (p.stock || 0) > 0 && (p.stock || 0) <= 10).length;
            const outOfStock = products.filter(p => (p.stock || 0) === 0).length;
            const featured = products.filter(p => p.featured).length;
            
            document.getElementById('total-products').textContent = totalProducts;
            document.getElementById('in-stock-products').textContent = inStock;
            document.getElementById('low-stock-products').textContent = lowStock;
            document.getElementById('out-of-stock-products').textContent = outOfStock;
            
            document.getElementById('products-count').textContent = `${totalProducts} products`;
            document.getElementById('filter-info').textContent = `‚Ä¢ ${inStock} in stock ‚Ä¢ ${lowStock} low stock ‚Ä¢ ${outOfStock} out of stock ‚Ä¢ ${featured} featured`;
        }

        function filterProducts() {
            const searchTerm = document.getElementById('search-products').value.toLowerCase();
            const categoryFilter = document.getElementById('category-filter').value;
            const stockFilter = document.getElementById('stock-filter').value;
            const statusFilter = document.getElementById('status-filter').value;
            
            let filtered = allProducts.filter(product => {
                const matchesSearch = 
                    product.name.toLowerCase().includes(searchTerm) || 
                    (product.brand && product.brand.toLowerCase().includes(searchTerm)) ||
                    (product.description && product.description.toLowerCase().includes(searchTerm));
                const matchesCategory = categoryFilter === 'all' || product.category === categoryFilter;
                const matchesStock = stockFilter === 'all' || getStockStatus(product.stock || 0) === stockFilter;
                const matchesStatus = statusFilter === 'all' || 
                    (statusFilter === 'featured' && product.featured) ||
                    (statusFilter === 'active' && product.active !== false) ||
                    (statusFilter === 'inactive' && product.active === false);
                
                return matchesSearch && matchesCategory && matchesStock && matchesStatus;
            });
            
            displayProducts(filtered);
            updateStats(filtered);
        }

        function resetFilters() {
            document.getElementById('search-products').value = '';
            document.getElementById('category-filter').value = 'all';
            document.getElementById('stock-filter').value = 'all';
            document.getElementById('status-filter').value = 'all';
            displayProducts(allProducts);
            updateStats(allProducts);
        }

        function toggleProductForm() {
            const form = document.getElementById('product-form');
            const toggleBtn = document.getElementById('toggle-form-btn');
            
            if (form.style.display === 'none') {
                form.style.display = 'block';
                toggleBtn.innerHTML = '<span>‚àí</span> Hide Form';
                form.scrollIntoView({ behavior: 'smooth' });
            } else {
                form.style.display = 'none';
                toggleBtn.innerHTML = '<span>+</span> Add New Product';
                resetProductForm();
            }
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('products').style.display = 'none';
            document.getElementById('no-products').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('products').style.display = 'grid';
        }

        function showNoProducts() {
            document.getElementById('no-products').style.display = 'block';
            document.getElementById('products').innerHTML = '';
        }

        function showError(message) {
            alert(message);
        }

        // Form submission
        document.getElementById('product-form').addEventListener('submit', async e => {
            e.preventDefault();
            
            // Collect all image URLs
            const images = [
                document.getElementById('product-image1').value,
                document.getElementById('product-image2').value,
                document.getElementById('product-image3').value,
                document.getElementById('product-image4').value,
                document.getElementById('product-image5').value
            ].filter(img => img.trim() !== '');
            
            // Get selected sizes
            const sizeCheckboxes = document.querySelectorAll('input[name="sizes"]:checked');
            const sizes = Array.from(sizeCheckboxes).map(cb => cb.value);
            
            // Parse details and care instructions from textarea
            const detailsText = document.getElementById('product-details').value;
            const details = detailsText.split('\n').filter(line => line.trim() !== '');
            
            const careText = document.getElementById('product-care-instructions').value;
            const careInstructions = careText.split('\n').filter(line => line.trim() !== '');
            
            const product = {
                name: document.getElementById('product-name').value.trim(),
                brand: document.getElementById('product-brand').value.trim(),
                category: document.getElementById('product-category').value,
                fit: document.getElementById('product-fit').value,
                price: parseFloat(document.getElementById('product-price').value),
                originalPrice: parseFloat(document.getElementById('product-original-price').value) || null,
                stock: parseInt(document.getElementById('product-stock').value) || 0,
                images: images,
                description: document.getElementById('product-description').value.trim(),
                detailedDescription: document.getElementById('product-detailed-description').value.trim(),
                details: details,
                careInstructions: careInstructions,
                color: document.getElementById('product-color').value.trim(),
                fabric: document.getElementById('product-fabric').value.trim(),
                material: document.getElementById('product-material').value.trim(),
                printType: document.getElementById('product-print-type').value.trim(),
                deliveryTime: document.getElementById('product-delivery-time').value.trim(),
                sizes: sizes,
                rating: parseFloat(document.getElementById('product-rating').value),
                reviewCount: parseInt(document.getElementById('product-review-count').value) || 0,
                featured: document.getElementById('product-featured').checked,
                active: document.getElementById('product-active').checked,
                sku: document.getElementById('product-sku').value.trim()
            };
            
            // Validation
            if (product.price < 0) {
                alert('Price cannot be negative');
                return;
            }
            
            if (product.stock < 0) {
                alert('Stock cannot be negative');
                return;
            }
            
            if (sizes.length === 0) {
                alert('Please select at least one size');
                return;
            }
            
            try {
                const id = document.getElementById('product-id').value;
                const method = id ? 'PUT' : 'POST';
                const url = id ? `/api/admin/products/${id}` : '/api/admin/products';
                
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(product)
                });
                
                const data = await response.json();
                if (data.success) {
                    alert(id ? 'Product updated successfully' : 'Product added successfully');
                    resetProductForm();
                    toggleProductForm();
                    loadProducts();
                } else {
                    alert(data.message || 'Failed to save product');
                }
            } catch (error) {
                console.error('Error saving product:', error);
                alert('Error saving product');
            }
        });

        async function editProduct(id) {
            try {
                const response = await fetch(`/api/admin/products/${id}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    const product = data.product;
                    
                    // Fill form with product data
                    document.getElementById('product-id').value = product._id;
                    document.getElementById('product-name').value = product.name || '';
                    document.getElementById('product-brand').value = product.brand || 'Astros Kulture';
                    document.getElementById('product-category').value = product.category || '';
                    document.getElementById('product-fit').value = product.fit || 'regular';
                    document.getElementById('product-price').value = product.price || '';
                    document.getElementById('product-original-price').value = product.originalPrice || '';
                    document.getElementById('product-stock').value = product.stock || 0;
                    document.getElementById('product-sku').value = product.sku || '';
                    document.getElementById('product-description').value = product.description || '';
                    document.getElementById('product-detailed-description').value = product.detailedDescription || '';
                    document.getElementById('product-color').value = product.color || '';
                    document.getElementById('product-fabric').value = product.fabric || '';
                    document.getElementById('product-material').value = product.material || '';
                    document.getElementById('product-print-type').value = product.printType || '';
                    document.getElementById('product-delivery-time').value = product.deliveryTime || '';
                    document.getElementById('product-rating').value = product.rating || 4.5;
                    document.getElementById('product-review-count').value = product.reviewCount || 0;
                    document.getElementById('product-featured').checked = product.featured || false;
                    document.getElementById('product-active').checked = product.active !== false;
                    
                    // Handle images array
                    const imageArray = Array.isArray(product.images) ? product.images : [];
                    document.getElementById('product-image1').value = imageArray[0] || '';
                    document.getElementById('product-image2').value = imageArray[1] || '';
                    document.getElementById('product-image3').value = imageArray[2] || '';
                    document.getElementById('product-image4').value = imageArray[3] || '';
                    document.getElementById('product-image5').value = imageArray[4] || '';
                    
                    // Handle sizes array
                    const sizeArray = Array.isArray(product.sizes) ? product.sizes : ['M', 'L', 'XL'];
                    document.querySelectorAll('input[name="sizes"]').forEach(checkbox => {
                        checkbox.checked = sizeArray.includes(checkbox.value);
                    });
                    
                    // Handle details array
                    const detailsArray = Array.isArray(product.details) ? product.details : [];
                    document.getElementById('product-details').value = detailsArray.join('\n');
                    
                    // Handle care instructions array
                    const careArray = Array.isArray(product.careInstructions) ? product.careInstructions : [];
                    document.getElementById('product-care-instructions').value = careArray.join('\n');
                    
                    // Update form title and submit button
                    document.getElementById('product-submit').textContent = 'Update Product';
                    document.getElementById('form-title').textContent = 'Edit Product';
                    
                    // Show form and scroll to it
                    const form = document.getElementById('product-form');
                    if (form.style.display === 'none') {
                        toggleProductForm();
                    }
                    form.scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('Failed to load product for editing');
                }
            } catch (error) {
                console.error('Error loading product for editing:', error);
                alert('Error loading product for editing');
            }
        }

        function viewProduct(id) {
            window.open(`product.html?id=${id}`, '_blank');
        }

        function resetProductForm() {
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            document.getElementById('product-submit').textContent = 'Add Product';
            document.getElementById('form-title').textContent = 'Add New Product';
            document.getElementById('product-brand').value = 'Astros Kulture';
            document.getElementById('product-material').value = '100% Cotton';
            document.getElementById('product-delivery-time').value = '3-7 business days';
            document.getElementById('product-rating').value = '4.5';
            document.getElementById('product-active').checked = true;
            
            // Set default sizes
            document.querySelectorAll('input[name="sizes"]').forEach(checkbox => {
                checkbox.checked = ['S', 'M', 'L', 'XL'].includes(checkbox.value);
            });
        }

        async function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
                try {
                    const response = await fetch(`/api/admin/products/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    const data = await response.json();
                    if (data.success) {
                        alert('Product deleted successfully');
                        loadProducts();
                    } else {
                        alert(data.message || 'Failed to delete product');
                    }
                } catch (error) {
                    console.error('Error deleting product:', error);
                    alert('Error deleting product');
                }
            }
        }

        function quickUpdateStock(productId, currentStock) {
            const newStock = prompt(`Update stock quantity for this product:\nCurrent stock: ${currentStock}`, currentStock);
            if (newStock !== null && !isNaN(newStock) && newStock >= 0) {
                updateStock(productId, parseInt(newStock));
            }
        }

        async function updateStock(productId, newStock) {
            try {
                const response = await fetch(`/api/admin/products/${productId}/stock`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ stock: newStock })
                });
                const data = await response.json();
                if (data.success) {
                    alert('Stock updated successfully');
                    loadProducts();
                } else {
                    alert(data.message || 'Failed to update stock');
                }
            } catch (error) {
                console.error('Error updating stock:', error);
                alert('Error updating stock');
            }
        }

        function exportProducts() {
            alert('Export functionality would be implemented here');
            // This would typically generate a CSV or Excel file of all products
        }

        function bulkUpdateStock() {
            alert('Bulk stock update functionality would be implemented here');
            // This would open a modal for updating multiple products' stock at once
        }

        // Event Listeners for search and mobile search
        document.getElementById('search-products').addEventListener('input', filterProducts);
        document.getElementById('product-search').addEventListener('input', filterProducts);
        document.getElementById('mobile-product-search').addEventListener('input', filterProducts);

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            const isAdmin = await checkAdmin();
            if (isAdmin) {
                loadProducts();
            }
        });
    </script>
</body>
</html>
