<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Products - Astros Kulture</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="navbar">
        <div class="logo">
            <img src="logo.png" alt="Astros Kulture">
        </div>
        <div class="menu-toggle">☰</div>
        <ul class="nav-links">
            <li><a href="admin.html">Dashboard</a></li>
            <li><a href="admin-home.html">Home Config</a></li>
            <li><a href="admin-products.html">Products</a></li>
            <li><a href="admin-orders.html">Orders</a></li>
            <li><a href="admin-users.html">Users</a></li>
            <li><a href="#" onclick="logout()">Logout</a></li>
        </ul>
    </nav>

    <section class="admin fade-in">
        <h2>Manage Products</h2>
        
        <!-- Search and Filter Bar -->
        <div class="admin-toolbar">
            <div class="search-box">
                <input type="text" id="search-products" placeholder="Search products..." onkeyup="filterProducts()">
                <select id="category-filter" onchange="filterProducts()">
                    <option value="all">All Categories</option>
                    <option value="oversized">Oversized</option>
                    <option value="normal">Normal</option>
                </select>
                <select id="stock-filter" onchange="filterProducts()">
                    <option value="all">All Stock</option>
                    <option value="in-stock">In Stock</option>
                    <option value="low-stock">Low Stock</option>
                    <option value="out-of-stock">Out of Stock</option>
                </select>
            </div>
            <button class="btn" onclick="toggleProductForm()" id="toggle-form-btn">+ Add New Product</button>
        </div>

        <!-- Product Form (Initially hidden) -->
        <form id="product-form" class="home-config-form slide-in-left" style="display: none;">
            <div class="form-header">
                <h3 id="form-title">Add New Product</h3>
                <button type="button" class="close-btn" onclick="toggleProductForm()">×</button>
            </div>
            
            <input type="hidden" id="product-id">
            
            <!-- Basic Information -->
            <div class="form-section">
                <h3>Basic Information</h3>
                <div class="form-row">
                    <input type="text" id="product-name" placeholder="Product Name" required>
                    <input type="text" id="product-category" placeholder="Category (oversized/normal)" required>
                </div>
                <div class="form-row">
                    <input type="number" id="product-price" placeholder="Current Price" step="0.01" min="0" required>
                    <input type="number" id="product-original-price" placeholder="Original Price (for discount)" step="0.01" min="0">
                    <input type="number" id="product-stock" placeholder="Stock Quantity" min="0" value="0" required>
                </div>
            </div>

            <!-- Product Images -->
            <div class="form-section">
                <h3>Product Images</h3>
                <small>Enter image URLs (up to 5 images)</small>
                <div class="image-urls">
                    <input type="text" id="product-image1" placeholder="Image URL 1">
                    <input type="text" id="product-image2" placeholder="Image URL 2">
                    <input type="text" id="product-image3" placeholder="Image URL 3">
                    <input type="text" id="product-image4" placeholder="Image URL 4">
                    <input type="text" id="product-image5" placeholder="Image URL 5">
                </div>
            </div>

            <!-- Product Description -->
            <div class="form-section">
                <h3>Product Description</h3>
                <textarea id="product-description" placeholder="Short Description (appears in product listings)"></textarea>
                <textarea id="product-detailed-description" placeholder="Detailed Description (supports HTML, appears on product page)"></textarea>
            </div>

            <!-- Product Details -->
            <div class="form-section">
                <h3>Product Details</h3>
                <textarea id="product-details" placeholder="Enter product details, one per line
Example: 
Unisex, Oversized Comfort Fit
250-260 GSM Looper Cotton
High Density Puff Print"></textarea>
            </div>

            <!-- Care Instructions -->
            <div class="form-section">
                <h3>Care Instructions</h3>
                <textarea id="product-care-instructions" placeholder="Enter care instructions, one per line
Example:
Machine Reverse Wash
Steam Iron Only
Do Not Bleach"></textarea>
            </div>

            <!-- Additional Information -->
            <div class="form-section">
                <h3>Additional Information</h3>
                <div class="form-row">
                    <input type="text" id="product-color" placeholder="Color">
                    <input type="text" id="product-fabric" placeholder="Fabric">
                </div>
                <div class="form-row">
                    <input type="text" id="product-print-type" placeholder="Print Type">
                    <input type="text" id="product-delivery-time" placeholder="Delivery Time">
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" id="product-submit" class="btn primary-btn">Add Product</button>
                <button type="button" class="btn secondary-btn" onclick="resetProductForm()">Reset Form</button>
                <button type="button" class="btn secondary-btn" onclick="toggleProductForm()">Cancel</button>
            </div>
        </form>

        <!-- Products Grid -->
        <div class="products-stats">
            <span id="products-count">0 products</span>
            <span id="stock-summary"></span>
        </div>
        
        <div id="products" class="admin-products-grid"></div>
        
        <!-- Loading State -->
        <div id="loading" class="loading-state">
            <div class="loading-spinner"></div>
            <p>Loading products...</p>
        </div>
    </section>

    <footer>
        <p>&copy; 2025 Astros Kulture. Contact: info@astroskulture.com</p>
        <div class="footer-links">
            <a href="#">Terms</a>
            <a href="#">Privacy</a>
            <a href="#">Return Policy</a>
        </div>
    </footer>

    <script src="script.js"></script>
    <script>
        let allProducts = [];
        
        async function checkAdmin() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }
            try {
                const response = await fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (!data.success || data.data.role !== 'admin') {
                    window.location.href = 'login.html';
                    return false;
                }
                return true;
            } catch (error) {
                window.location.href = 'login.html';
                return false;
            }
        }

        async function loadProducts() {
            showLoading();
            try {
                const response = await fetch('/api/admin/products', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const data = await response.json();
                if (data.success) {
                    allProducts = data.products;
                    displayProducts(allProducts);
                    updateStats(allProducts);
                } else {
                    document.getElementById('products').innerHTML = `
                        <div class="no-products">
                            <h3>No Products Found</h3>
                            <p>Get started by adding your first product!</p>
                            <button class="btn" onclick="toggleProductForm()">Add First Product</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('products').innerHTML = `
                    <div class="error-state">
                        <h3>Error Loading Products</h3>
                        <p>Please check your connection and try again.</p>
                        <button class="btn" onclick="loadProducts()">Retry</button>
                    </div>
                `;
            } finally {
                hideLoading();
            }
        }

        function displayProducts(products) {
            const container = document.getElementById('products');
            if (products.length === 0) {
                container.innerHTML = `
                    <div class="no-products">
                        <h3>No Products Match Your Search</h3>
                        <p>Try adjusting your filters or search terms.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = products.map(product => {
                const discount = product.originalPrice && product.originalPrice > product.price ? 
                    Math.round(((product.originalPrice - product.price) / product.originalPrice) * 100) : 0;
                
                const stockStatus = getStockStatus(product.stock || 0);
                
                return `
                    <div class="product-item" data-category="${product.category}" data-stock="${stockStatus}">
                        <div class="product-image">
                            ${product.images && product.images.length > 0 ? 
                                `<img src="${product.images[0]}" alt="${product.name}" 
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                 <div class="no-image" style="display: none;">No Image</div>` : 
                                '<div class="no-image">No Image</div>'
                            }
                            ${discount > 0 ? `<div class="discount-badge">${discount}% OFF</div>` : ''}
                            <div class="stock-badge ${stockStatus}">${stockStatus.replace('-', ' ')}</div>
                        </div>
                        <div class="product-info">
                            <h4 class="product-name">${product.name}</h4>
                            <p class="product-category">${product.category}</p>
                            <div class="price-section">
                                <span class="current-price">₹${(product.price || 0).toFixed(2)}</span>
                                ${product.originalPrice && product.originalPrice > product.price ? 
                                    `<span class="original-price">₹${product.originalPrice.toFixed(2)}</span>` : 
                                    ''
                                }
                            </div>
                            <div class="product-meta">
                                <span class="meta-item">
                                    <strong>Stock:</strong> ${product.stock || 0}
                                </span>
                                <span class="meta-item">
                                    <strong>Color:</strong> ${product.color || 'N/A'}
                                </span>
                                <span class="meta-item">
                                    <strong>Images:</strong> ${product.images ? product.images.length : 0}
                                </span>
                            </div>
                            <p class="created-date">
                                Created: ${new Date(product.createdAt || Date.now()).toLocaleDateString('en-IN')}
                            </p>
                        </div>
                        <div class="product-actions">
                            <button class="btn edit-btn" onclick="editProduct('${product._id}')" title="Edit Product">
                                <span>✏️ Edit</span>
                            </button>
                            <button class="btn delete-btn" onclick="deleteProduct('${product._id}')" title="Delete Product">
                                <span>🗑️ Delete</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getStockStatus(stock) {
            if (stock > 10) return 'in-stock';
            if (stock > 0) return 'low-stock';
            return 'out-of-stock';
        }

        function updateStats(products) {
            const totalProducts = products.length;
            const inStock = products.filter(p => (p.stock || 0) > 10).length;
            const lowStock = products.filter(p => (p.stock || 0) > 0 && (p.stock || 0) <= 10).length;
            const outOfStock = products.filter(p => (p.stock || 0) === 0).length;
            
            document.getElementById('products-count').textContent = `${totalProducts} products`;
            document.getElementById('stock-summary').textContent = 
                `• ${inStock} in stock • ${lowStock} low stock • ${outOfStock} out of stock`;
        }

        function filterProducts() {
            const searchTerm = document.getElementById('search-products').value.toLowerCase();
            const categoryFilter = document.getElementById('category-filter').value;
            const stockFilter = document.getElementById('stock-filter').value;
            
            let filtered = allProducts.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchTerm) || 
                                    (product.description && product.description.toLowerCase().includes(searchTerm));
                const matchesCategory = categoryFilter === 'all' || product.category === categoryFilter;
                const matchesStock = stockFilter === 'all' || getStockStatus(product.stock || 0) === stockFilter;
                
                return matchesSearch && matchesCategory && matchesStock;
            });
            
            displayProducts(filtered);
            updateStats(filtered);
        }

        function toggleProductForm() {
            const form = document.getElementById('product-form');
            const toggleBtn = document.getElementById('toggle-form-btn');
            
            if (form.style.display === 'none') {
                form.style.display = 'block';
                toggleBtn.textContent = '− Hide Form';
                form.scrollIntoView({ behavior: 'smooth' });
            } else {
                form.style.display = 'none';
                toggleBtn.textContent = '+ Add New Product';
                resetProductForm();
            }
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('products').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('products').style.display = 'grid';
        }

        // Form submission and other functions remain the same as your original code
        document.getElementById('product-form').addEventListener('submit', async e => {
            e.preventDefault();
            
            // Collect all image URLs
            const images = [
                document.getElementById('product-image1').value,
                document.getElementById('product-image2').value,
                document.getElementById('product-image3').value,
                document.getElementById('product-image4').value,
                document.getElementById('product-image5').value
            ].filter(img => img.trim() !== '');
            
            // Parse details and care instructions from textarea
            const detailsText = document.getElementById('product-details').value;
            const details = detailsText.split('\n').filter(line => line.trim() !== '');
            
            const careText = document.getElementById('product-care-instructions').value;
            const careInstructions = careText.split('\n').filter(line => line.trim() !== '');
            
            const product = {
                name: document.getElementById('product-name').value.trim(),
                category: document.getElementById('product-category').value.trim(),
                price: parseFloat(document.getElementById('product-price').value),
                originalPrice: parseFloat(document.getElementById('product-original-price').value) || null,
                stock: parseInt(document.getElementById('product-stock').value) || 0,
                images: images,
                description: document.getElementById('product-description').value.trim(),
                detailedDescription: document.getElementById('product-detailed-description').value.trim(),
                details: details,
                careInstructions: careInstructions,
                color: document.getElementById('product-color').value.trim(),
                fabric: document.getElementById('product-fabric').value.trim(),
                printType: document.getElementById('product-print-type').value.trim(),
                deliveryTime: document.getElementById('product-delivery-time').value.trim()
            };
            
            if (product.price < 0) {
                alert('Price cannot be negative');
                return;
            }
            
            if (product.stock < 0) {
                alert('Stock cannot be negative');
                return;
            }
            
            try {
                const id = document.getElementById('product-id').value;
                const method = id ? 'PUT' : 'POST';
                const url = id ? `/api/admin/products/${id}` : '/api/admin/products';
                
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(product)
                });
                
                const data = await response.json();
                if (data.success) {
                    alert(id ? 'Product updated successfully' : 'Product added successfully');
                    resetProductForm();
                    toggleProductForm();
                    loadProducts();
                } else {
                    alert(data.message || 'Failed to save product');
                }
            } catch (error) {
                console.error('Error saving product:', error);
                alert('Error saving product');
            }
        });

        async function editProduct(id) {
            try {
                const response = await fetch(`/api/admin/products/${id}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const data = await response.json();
                
                if (data.success) {
                    const product = data.product;
                    
                    document.getElementById('product-id').value = product._id;
                    document.getElementById('product-name').value = product.name || '';
                    document.getElementById('product-category').value = product.category || '';
                    document.getElementById('product-price').value = product.price || '';
                    document.getElementById('product-original-price').value = product.originalPrice || '';
                    document.getElementById('product-stock').value = product.stock || 0;
                    document.getElementById('product-description').value = product.description || '';
                    document.getElementById('product-detailed-description').value = product.detailedDescription || '';
                    document.getElementById('product-color').value = product.color || '';
                    document.getElementById('product-fabric').value = product.fabric || '';
                    document.getElementById('product-print-type').value = product.printType || '';
                    document.getElementById('product-delivery-time').value = product.deliveryTime || '';
                    
                    // Handle images array
                    const imageArray = Array.isArray(product.images) ? product.images : [];
                    document.getElementById('product-image1').value = imageArray[0] || '';
                    document.getElementById('product-image2').value = imageArray[1] || '';
                    document.getElementById('product-image3').value = imageArray[2] || '';
                    document.getElementById('product-image4').value = imageArray[3] || '';
                    document.getElementById('product-image5').value = imageArray[4] || '';
                    
                    // Handle details array
                    const detailsArray = Array.isArray(product.details) ? product.details : [];
                    document.getElementById('product-details').value = detailsArray.join('\n');
                    
                    // Handle care instructions array
                    const careArray = Array.isArray(product.careInstructions) ? product.careInstructions : [];
                    document.getElementById('product-care-instructions').value = careArray.join('\n');
                    
                    document.getElementById('product-submit').textContent = 'Update Product';
                    document.getElementById('form-title').textContent = 'Edit Product';
                    
                    // Show form and scroll to it
                    toggleProductForm();
                } else {
                    alert('Failed to load product for editing');
                }
            } catch (error) {
                console.error('Error loading product for editing:', error);
                alert('Error loading product for editing');
            }
        }

        function resetProductForm() {
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            document.getElementById('product-submit').textContent = 'Add Product';
            document.getElementById('form-title').textContent = 'Add New Product';
        }

        async function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
                try {
                    const response = await fetch(`/api/admin/products/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    const data = await response.json();
                    if (data.success) {
                        alert('Product deleted successfully');
                        loadProducts();
                    } else {
                        alert(data.message || 'Failed to delete product');
                    }
                } catch (error) {
                    console.error('Error deleting product:', error);
                    alert('Error deleting product');
                }
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            const isAdmin = await checkAdmin();
            if (isAdmin) {
                loadProducts();
            }
        });
    </script>
</body>
</html>
